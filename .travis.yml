dist: xenial
services: docker

language: python
python:
  - '3.6'

env:
  global:
    secure: 'tv+TH7Kuzus5C7m855nrXijMNz5lDavV7FM/UUsoAj92CdBXM0BqnlG/gokgMwMRvPEjAz4Ppgfu0WcukAujFd9UJ2VDLWCYLoHfIf731Rv8U5TFJSCq/B34QVCvP85JkAWc+rMfr7NPDFVzXh1CZxRVQLQZrGMRl1QS9RVhSYsIo572EICQQ8R4XgWJ2m5SbT17M5xiit0IF9RCI+NNzhiM4BnpFZ4iWN7DmKWkXOvnjUtJ5262tHhKXHHQ9A9NdOiofRxnwqYmmfEe8TjH0Hi1uLIgIViBuAI0/RZiH+3OK/D8lZ8gtSLOKTmBvdvf24+lCk3wbgS7Q6I4HShdlk3drnbxmRnoPEVH6YS2fA78rNspYT0sc+MwINoI+BQaeah9HGqykhxdHTlE9nqm8ialEtkh0m8W4QG/dI93kR4pv+Fz/x/bXoqubsPfpKeZq1sDnS8esrg+LYcx1EYKfjqmLGHQzoHSgl4y5bY17yU9suZJCKHXkL2cCmTawLdJYE1Yk6Y0JbWZBViMUA1WtCwQ8IMROrzMDuY0xL0HNO0S9+0uGE7XsRv+36yF0GU/KGw7QurVWnsAkxxZasscDYnFU4XfnTAkhTgtfuSVwlpy8VQBoAT9HDNli7g3od24XdgVuwi57WacDiWe88YNPacd0GXwBqRtLcFOhyvvb/8='
    secure: 'GBJRROh4mQ+wR56RqOhcTxGODGf5HbtvnwDB8UoVFytBUjrwTFRE4lHbLk162Pax8d4HJ+EkRR30a6EFEvyBNpoE2zQxNS7WGWnEqMq18vlHvMM/3qPzw7wb3DpRHLf560B434lRVRbq/GVdWO0lxQpEBhSJF1O9gvA79EDGyAYiehQdSmXCZWeS4KDSQj4EH3AAM2CHIRWFVGO1zgxH7Tdy3DQvFUk3byK3ZcplbTXagfMWbWNK2kffj+k6qhzj0ZFIMJvfdJ8jcniY2JGnq93Xc22JvYn77GpDqE0LpR3ttBBRzITmSnADb5zwTjtkSER8a3C+TS8h6VzGd3FkMj+nhWj/+qmB3bGrHmEq+QeWgXXUZ3lIDqfJ40QtSJ4/+dCdqNea1qEYFYnmO3SOYbJPY02gv+RCz9sX/qG72YG1UJtUfs9sUT6kKqTWQFbQJt1JK4P4STY8sIPN82eFxEek6d9JxzER4zB4dugOjJ5NsPs7UuM5chFPJJ0ci1r/CenPr/K4d9mPD2mjEywyvVgtVfYJZQmI02ZM2R6U5z81bgDuqi6ys+/y7Tyw0L3ekUz+HfoxZNSXq/KSVITvZEtO9RYLwJlLWJ5+118SzbpYrMq+l413JfyHCCMA5DffbUPZ+l5XSRhBeo4uaqofimicrWeKrLZWhX9oII/zk8A='

before_install:
  - curl --retry 5 -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - travis_retry sudo apt-get update
  - travis_retry sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
  - docker version

install:
  - travis_retry pip install -q docker molecule openshift jmespath

script:
  - molecule test -s test-local

after_success:
  - travis_retry docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
  - export IMAGE_TAG="$(./build-script-collection/get-version-git | tr '+' '_')"
  - docker build -f build/Dockerfile -t "elementalnet/ceph-osd-operator:$IMAGE_TAG" .
  - travis_retry docker push "elementalnet/ceph-osd-operator:$IMAGE_TAG"
